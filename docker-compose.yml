# docker-compose.yml — svid-exchange local dev environment
#
# Startup order:
#   spire-server (started) → spire-init (completed) → spire-agent (healthy) → svid-exchange
#
# Shared volume layout:
#   spire-sockets/
#     join-token        written by spire-init, read by spire-agent
#     agent.sock        written by spire-agent, read by svid-exchange
#
# Image notes:
#   spire-server/agent official images are distroless (no shell, no wget).
#   spire-init and spire-agent use dev/spire/Dockerfile.init which layers the
#   SPIRE binaries on top of Alpine, giving them a shell and standard tools.
#   spire-server runs as root (user: "0") so it can write to named volumes
#   that Docker creates owned by root — dev only, not for production.
#
# Usage:
#   make compose-up
#   docker compose down -v   # -v removes named volumes (clean slate)

name: svid-exchange-dev

services:

  # ── SPIRE Server ─────────────────────────────────────────────────────────────
  # Runs as root (dev only) so it can write to the root-owned named volume.
  # No Docker healthcheck — the distroless image has no wget/shell.
  # spire-init polls the HTTP health endpoint internally before registering entries.
  spire-server:
    image: ghcr.io/spiffe/spire-server:1.10.0
    user: "0"
    volumes:
      - ./dev/spire/server.conf:/opt/spire/conf/server.conf:ro
      - spire-data:/opt/spire/data/server
      - spire-sockets:/opt/spire/sockets   # exposes server.sock to spire-init
    command: ["-config", "/opt/spire/conf/server.conf"]

  # ── SPIRE Init (one-shot) ────────────────────────────────────────────────────
  # Alpine + SPIRE binaries (see dev/spire/Dockerfile.init).
  # Waits for the server HTTP health endpoint, generates a join token, and
  # registers all workload entries from policy.example.yaml.
  # Exits 0 on success; Docker Compose will not restart it.
  spire-init:
    build:
      context: dev/spire
      dockerfile: Dockerfile.init
    entrypoint: ["/bin/sh", "/opt/spire/conf/register-entries.sh"]
    volumes:
      - ./dev/spire/register-entries.sh:/opt/spire/conf/register-entries.sh:ro
      - spire-sockets:/opt/spire/sockets
    depends_on:
      spire-server:
        condition: service_started
    restart: "no"

  # ── SPIRE Agent ───────────────────────────────────────────────────────────────
  # Alpine + SPIRE binaries (see dev/spire/Dockerfile.init).
  # Reads the join token written by spire-init and attests to the server.
  # Exposes the Workload API socket at /opt/spire/sockets/agent.sock.
  # pid: host is required so the unix workload attestor can inspect the PID
  # (and therefore the UID) of any process that dials the socket.
  spire-agent:
    build:
      context: dev/spire
      dockerfile: Dockerfile.init
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        spire-agent run \
          -config /opt/spire/conf/agent.conf \
          -joinToken "$(cat /opt/spire/sockets/join-token)"
    volumes:
      - ./dev/spire/agent.conf:/opt/spire/conf/agent.conf:ro
      - spire-sockets:/opt/spire/sockets
      - spire-agent-data:/opt/spire/data/agent
    depends_on:
      spire-init:
        condition: service_completed_successfully
    healthcheck:
      # Port 8082 is the HTTP health endpoint configured in agent.conf.
      # wget is available because this container is Alpine-based.
      test: ["CMD-SHELL", "wget -qO- http://localhost:8082/ready || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    pid: "host"

  # ── svid-exchange ─────────────────────────────────────────────────────────────
  # Built from the local Dockerfile (scratch image).
  # mTLS certs are fetched live from the SPIRE Workload API — no static cert
  # files needed. SVID rotation is transparent: no restart required.
  svid-exchange:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      POLICY_FILE:            /config/policy.example.yaml
      SPIFFE_ENDPOINT_SOCKET: "unix:///opt/spire/sockets/agent.sock"
      GRPC_ADDR:              ":8080"
      HEALTH_ADDR:            ":8081"
    volumes:
      - ./config/policy.example.yaml:/config/policy.example.yaml:ro
      - spire-sockets:/opt/spire/sockets
    ports:
      - "8080:8080"   # gRPC (mTLS)
      - "8081:8081"   # health HTTP
    depends_on:
      spire-agent:
        condition: service_healthy

volumes:
  spire-data:        # SPIRE server: SQLite database + signing keys
  spire-agent-data:  # SPIRE agent: attestation state
  spire-sockets:     # shared: join-token (init→agent), Workload API socket (agent→exchange)
